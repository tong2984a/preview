<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Hello, Vegan!</title>
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/sidebar.css">
  <link href="css/selectbox.css" rel="stylesheet">
  <link href="css/autocomplete.css" rel="stylesheet">
  <link rel="stylesheet" href="css/leaflet.css" />
  <link rel="stylesheet" href="css/slideshow.css" />
  <link rel="stylesheet" href="css/leaflet-search.src.css" />
  <link rel="stylesheet" href="css/tagsinput.css" />
  <!-- Make sure you put this AFTER Leaflet's CSS -->
  <script src="js/leaflet.js" ></script>
  <style>
  #mapid { height: 480px; }
  /*Profile Pic Start*/
  .picture-container{
      position: relative;
      cursor: pointer;
      text-align: center;
      margin: 0px auto;
  }
  .picture{
      width: 106px;
      height: 106px;
      background-color: #999999;
      border: 4px solid #CCCCCC;
      color: #FFFFFF;
      border-radius: 50%;
      margin: 0px auto;
      overflow: hidden;
      transition: all 0.2s;
      -webkit-transition: all 0.2s;
  }
  .picture:hover{
      border-color: #2ca8ff;
  }
  .content.ct-wizard-green .picture:hover{
      border-color: #05ae0e;
  }
  .content.ct-wizard-blue .picture:hover{
      border-color: #3472f7;
  }
  .content.ct-wizard-orange .picture:hover{
      border-color: #ff9500;
  }
  .content.ct-wizard-red .picture:hover{
      border-color: #ff3b30;
  }
  .picture input[type="file"] {
      cursor: pointer;
      display: block;
      height: 100%;
      left: 0;
      opacity: 0 !important;
      position: absolute;
      top: 0;
      width: 100%;
  }

  .picture-src{
      width: 100%;

  }
  /*Profile Pic End*/

  </style>
</head>
<body>

  <div class="container">
    <div class="jumbotron">
      <p class="text-center">
        <a href="main.html">
          <img src="images/i128x128.png" class="img-responsive" style="margin:0 auto;" alt="Responsive image">
        </a>
      </p>
      <h4 class="text-center">Plant forward. Support our Patreon, or Shop with Us !</h4>
      <p class="text-center">
        <a href="https://linktr.ee/PAY_A_VEGAN">https://linktr.ee/PAY_A_VEGAN</a> <small>v1.17.0</small>
      </p>
      <p class="text-left font-weight-normal">
        Technical Instructions for Beta Users<br/>
        a. Compatible with iphone, SamSung, Google<br/>
        b. Best with Safari, Chrome, Firefox, Brave, Opera<br/>
        c. Remove Cache / search history of your phone browser<br/>
        d. Refresh browser<br/>
        e. Turn on GPS<br/>
        f. Allow browser to use GPS
        </p>
        <p class="text-left small">
          <a href='#' onclick='window.open(`mailto:contact@pay-a-vegan.com`, `_self`);'>contact@pay-a-vegan.com</a> for :<br/>
        a. Technical problem<br/>
        b. Suggestions & Comments<br/>
        c. Privacy Concern
        </p>
    </div>

<div id="mapid"></div>

    <div class="row justify-content-center">
      <div class="col-sm-6">
        <p id="instruction" style="display: none;">Please drag the red pin to the place you want to choose</p>
        <input type="url" id="locationInput" class="form-control input-lg" style="display: none;" >
        <p><label id="locationLabel" for="locationInput" class="btn btn-primary my-2 btn-default btn-block btn-lg" style="display: none;" onclick="getCurrentLocation()">Set Location</label></p>
        <input type="text" id="address" class="form-control input-lg" style="display: none;">

        <p><label id="addressConfirm" for="address" class="btn btn-primary my-2 btn-default btn-block btn-lg" style="cursor: pointer;display: none;">Confirm Address</label></p>
      </div>
    </div>
    <!-- Ricardo: input restaurant -->
  <div id="after-location-loaded">
    <div class="row justify-content-center">
      <div class="col-sm-6 form-group">
        <div class="autocomplete">
          <input type="text" maxlength="999"
          class="form-control input-lg"
          id="restaurantInput"
          placeholder="What is the name of the restaurant?"
          >
        </div>
      </div>
    </div>

    <!-- Ricardo: input dish -->
    <div class="row justify-content-center">
      <div class="col-sm-6 form-group">
        <input type="text"
        class="form-control input-lg"
        id="dishInput"
        data-toggle="popover" title="Popover title" data-placement="top" data-content="MEAT FREE, DAIRY FREE & EGG FREE ; 無肉，無蛋奶"
        placeholder="What is the name of the dish?">
      </div>
    </div>

    <div class="row justify-content-center">
      <div class="col-sm-6 form-group">
        <input type="text"
        class="form-control input-lg"
        id="helloMessageInput"
        placeholder="How do you like the Vegan Dish?">
      </div>
    </div>

    <span class="glyphicon glyphicon-plus"></span>
    <div class="row justify-content-center">
      <img id="preview" src="" />
      <div class="picture-container">
        <div class="picture">
          <img src="https://mdbootstrap.com/img/Photos/Others/placeholder.jpg" class="picture-src" id="dishPicturePreview" title="">
          <input type="file" id="dish-picture" class="">
        </div>
        <span id="upload-dish" class="badge badge-primary badge-pill">Upload Dish
          <svg id="upload-dish-checkmark" display="none" width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-check" fill="green" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" d="M10.97 4.97a.75.75 0 0 1 1.071 1.05l-3.992 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.236.236 0 0 1 .02-.022z"/>
          </svg>
        </span>
      </div>
      <div class="picture-container">
        <div class="picture">
          <img src="https://mdbootstrap.com/img/Photos/Others/placeholder-avatar.jpg" class="picture-src" id="receiptPicturePreview" title="">
          <input type="file" id="receipt-picture" class="">
        </div>
        <span id="upload-receipt" class="badge badge-pill badge-primary">Upload Receipt
          <svg id="upload-receipt-checkmark" display="none" width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-check" fill="green" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" d="M10.97 4.97a.75.75 0 0 1 1.071 1.05l-3.992 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.236.236 0 0 1 .02-.022z"/>
          </svg>
        </span>
      </div>
    </div>
  </div>

    <div class="row justify-content-center">
      <div class="col-xs-12" id="tags" style="display: none;">
        <div id="selectbox-container">
          <form>
            <label for="name">Cuisine:</label>
            <select name="" id="indexCuisines">
              <option value="">Please Select</option>
            </select>

            <span id="indexCategoryBlock">
              <label for="name">Category:</label>
              <select name="" id="indexCategories">
                <option value="">Please Select</option>
              </select>
            </span>

            <span id="indexIngredientBlock">
              <label for="name">Ingredient:</label>
              <input id="indexIngredients" type="text" data-role="tagsinput" value="">
            </span>
          </form>
        </div>
      </div>
    </div>

    <!-- Ricardo tags-->
    <div class="row justify-content-center" >
      <div class="col-xs-12 btn-group-toggle" id="tags" style="display: none;">
        <input type="checkbox" id="gluten-free" name="">
        <label for="gluten-free">Gluten-free</label>
        <input type="checkbox" id="egg-free" name="">
        <label for="egg-free">Egg-free</label>
        <br>
        <input type="checkbox" id="dairy-free" name="">
        <label for="dairy-free">Dairy-free</label>
        <input type="checkbox" id="treenut-free" name="">
        <label for="treenut-free">Treenut-free</label>
        <br>
        <input type="checkbox" id="peanut-free" name="">
        <label for="peanut-free">Peanut-free</label>
        <input type="checkbox" id="soy-free" name="">
        <label for="soy-free">Soy-free</label>
        <br>
        <input type="checkbox" id="raw" name="">
        <label for="raw">Raw</label>
        <input type="checkbox" id="vegan" name="">
        <label for="vegan">Vegan</label>
        <br>
        <input type="checkbox" id="buddhist-friendly" name="">
        <label for="buddhist-friendly">Buddhist-friendly</label>
        <input type="checkbox" id="all-natural" name="">
        <label for="all-natural">All natural</label>
      </div>
    </div>

    <!-- Send button -->
    <div class="row justify-content-center">
      <div class="col-xs-12">
        <button id="sendBtn" class="btn btn-success my-2 btn-default btn-block btn-lg" style="display: none;" onClick="upload()">
          Send
        </button>
      </div>
    </div>

    <!-- Add another dish button -->
    <div class="row justify-content-center">
      <div class="col-xs-12">
        <button id="addBtn" class="btn btn-success my-2 btn-default btn-block btn-lg" style="display: none;" onClick="refreshMap()">
          Add another dish
        </button>
      </div>
    </div>
  </div>

  <div class="row justify-content-center">
    <a href="main.html">
      <label id="back" class="btn btn-primary my-2 btn-default btn-block btn-lg" style="cursor: pointer;">Back to Main</label>
    </a>
  </div>

  <hr>

  <!-- Place to show the latest message -->
  <h2 class="text-center"></h2>
  <h3 id="helloMessageOutput" class="text-center text-warning">
    <span class="text-info"></span>
  </h3>

  <div class="progress md-progress" style="height: 20px">
    <div id="progressBar" class="progress-bar progress-bar-striped bg-success" role="progressbar" style="width: 0%; height: 15px" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
  </div>
  <hr>
</div>

<script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-storage.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-analytics.js"></script>
<script src="js/JIC.min.js" type="text/javascript"></script>
<script src="js/jquery-3.5.1.min.js"></script>
<script src="js/bootstrap.bundle.min.js" type="text/javascript"></script>
<script src="js/autocomplete.js"></script>
<script src="js/autocomplete2.js"></script>
<script src="js/tagsinput.js"></script>
<script src="js/leaflet-search.src.js"></script>
<script defer src="js/mapHelper.js" type="text/javascript"></script>
<script>

$(document).ready(function(){
  $('[data-toggle="popover"]').popover({
    trigger: 'focus'
  });

  // Prepare the preview for profile picture
  if (storageAvailable('localStorage')) {
    if(localStorage.getItem("dish")) {
      let currentImage = localStorage.getItem('dish');
      document.getElementById('dishPicturePreview').src = currentImage;
      var dateTime = new Date();
      dishImageFileName = dateTime + ".jpg";
      srcToFile(
        currentImage,
        dishImageFileName,
        'jpg'
      )
      .then(function(file){
        miniFiles["dish"] = file;
        console.log("miniFiles", miniFiles);
        let miniFileDish = miniFiles["dish"];
        let miniFileReceipt = miniFiles["receipt"];
        console.log("miniFileDish", miniFileDish);
        console.log("miniFileReceipt", miniFileReceipt);
        if (miniFileDish || miniFileReceipt) {
          document.getElementById('sendBtn').style.display = "block";
          document.getElementById('tags').style.display = "block";
        }
      })
    };
    if(localStorage.getItem("receipt")) {
      let currentImage = localStorage.getItem('receipt');
      document.getElementById('receiptPicturePreview').src = currentImage;
      var dateTime = new Date();
      receiptImageFileName = dateTime + ".jpg";
      srcToFile(
        currentImage,
        receiptImageFileName,
        'jpg'
      )
      .then(function(file){
        miniFiles["receipt"] = file;
        console.log("miniFiles", miniFiles);
        let miniFileDish = miniFiles["dish"];
        let miniFileReceipt = miniFiles["receipt"];
        console.log("miniFileDish", miniFileDish);
        console.log("miniFileReceipt", miniFileReceipt);
        if (miniFileDish || miniFileReceipt) {
          document.getElementById('sendBtn').style.display = "block";
          document.getElementById('tags').style.display = "block";
        }
      })
    }
  };
  $("#receipt-picture").change(function(){
    let dateTime = new Date();
    receiptImageFileName = dateTime + ".jpg";
    readPreviewURL(this, document.getElementById('receiptPicturePreview'), document.getElementById('upload-receipt'), document.getElementById('upload-receipt-checkmark'), "receipt", receiptImageFileName);
  });
  $("#dish-picture").change(function(){
    let dateTime = new Date();
    dishImageFileName = dateTime + ".jpg";
    readPreviewURL(this, document.getElementById('dishPicturePreview'), document.getElementById('upload-dish'), document.getElementById('upload-dish-checkmark'), "dish", dishImageFileName);
  });
});

window.addEventListener('load', initializeRestaurantsOnLoad);

function readPreviewURL(input, preview, label, checkmark, miniFile, imageFileName) {
  if (input.files && input.files[0]) {
    var reader = new FileReader();
    reader.onload = function (e) {
      var quality = 30;
      var output_format = "image/png";
      var img = new Image();
      img.src = e.target.result;
      img.onload = function() {
        //preview.attr('src', jic.compress(img,quality,output_format).src).fadeIn('slow');
        preview.src = jic.compress(img,quality,output_format).src;
        if (storageAvailable('localStorage')) {
          localStorage.setItem(miniFile, preview.src);
        }
        srcToFile(
          preview.src,
          imageFileName,
          'jpg'
        )
        .then(function(file){
          miniFiles[miniFile] = file;
          let filesize = ((file.size/1024)/1024).toFixed(4);
          console.log(`Finished compressing : ${filesize} MB`);
        })

        preview.onload = function() {
          document.getElementById('sendBtn').style.display = "block";
          document.getElementById('tags').style.display = "block";
          label.classList = "badge badge-pill badge-light";
          checkmark.style.display = "inline";
        }
      }
    }
    reader.readAsDataURL(input.files[0]);
  }
}

var mymap = L.map('mapid');
L.tileLayer('https://b.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxNativeZoom: 18,
    maxZoom: 20,
    attribution: '&copy; <a target="_blank" rel="noopener" href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(mymap);
var browserGeolocationSuccess = function(position) {
  currentLocation = [position.coords.latitude, position.coords.longitude];
  onLocationFound("You are here.");
};

var browserGeolocationFail = function(error) {
  onLocationFound("Refresh to find your location");
}

if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(
    browserGeolocationSuccess, browserGeolocationFail,
    {maximumAge: 70000, timeout: 40000, enableHighAccuracy: true}
  );
} else {
  onLocationFound("Cannot find your location");
}

function onMapClick(e) {
  var popup = L.popup();
    popup
        .setLatLng(e.latlng)
        .setContent("You clicked the map at " + e.latlng.toString())
        .openOn(mymap);
}

	function onLocationFound(message) {
    mymap.setView(currentLocation, 13);
    var radius = 1;
    circle = L.circle(currentLocation, {
        color: 'red',
        fillColor: '#f03',
        fillOpacity: 0.5,
        radius: 5
    }).addTo(mymap);
    let p = circle.bindPopup(message).openPopup();
    mymap.on('click', onMapClick);
	}

  function storageAvailable(type) {
      var storage;
      try {
          storage = window[type];
          var x = '__storage_test__';
          storage.setItem(x, x);
          storage.removeItem(x);
          return true;
      }
      catch(e) {
          return e instanceof DOMException && (
              // everything except Firefox
              e.code === 22 ||
              // Firefox
              e.code === 1014 ||
              // test name field too, because code might not be present
              // everything except Firefox
              e.name === 'QuotaExceededError' ||
              // Firefox
              e.name === 'NS_ERROR_DOM_QUOTA_REACHED') &&
              // acknowledge QuotaExceededError only if there's something already stored
              (storage && storage.length !== 0);
      }
  }

const firebaseConfig = {
    apiKey: "AIzaSyBg34hCq_jGHdj-HNWi2ZjfqhM2YgWq4ek",
    authDomain: "pay-a-vegan.firebaseapp.com",
    databaseURL: "https://pay-a-vegan.firebaseio.com",
    projectId: "pay-a-vegan",
    storageBucket: "pay-a-vegan.appspot.com",
    messagingSenderId: "587888386485",
    appId: "1:587888386485:web:3a81137924d19cbe2439fc",
    measurementId: "G-MGJK6GF9YW"
  };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
var storageRef = firebase.storage().ref();
var storage = firebase.storage();
initMap();
// DOM element shortcuts.
var helloMessageInput = document.getElementById('helloMessageInput');
var helloMessageOutput= document.getElementById('helloMessageOutput');
var preview= document.getElementById('preview');
var bar= document.getElementById('progressBar');
var miniFiles = [];
var dishInput = document.getElementById('dishInput');
var searchInput = document.getElementById('searchInput');
var restaurantInput = document.getElementById('restaurantInput');
var locationInput = document.getElementById('locationInput');
var map;
// added in 16/7
var defaultLocation = [22.3, 114.16];
var currentLocation = [22.276, 114.173];
var contentString = '<div>' +
                restaurantInput.value +
                '</div>' +
                '<div>' +
                dishInput.value +
                '</div>' +
                '<div>' +
                preview.value +
                '</div>' ;

var dishImageFileName = "";
var receiptImageFileName = "";
var isGlutenFree;
var isEggFree;
var isDairyFree;
var isTreenutFree;
var isPeanutFree;
var isSoyFree;
var isRaw;
var isVegan;
var isBuddhistFriendly;
var isAllNatural;
var referenceID;
// added in 23/7
var imgURL;

var request = {
    query: restaurantInput.value,
    fields: ['name', 'formatted_address', 'geometry'],
  };
var service;
var blueIcon;
var greenIcon;

var markers = [];
var showing = [];
var circle;
var current;
var currentLeaflet;
var currentUploadRestaurant;
var isNewRestaurant = false;
var restaurantHash = {};
const mode = "add";

function makeProgress(i){
  bar.style.width = i+'%';
  bar.innerText = i+'%';
  bar.setAttribute('aria-valuenow', i);
}

function srcToFile(src, fileName, mimeType) {
    return (fetch(src)
    .then(function(res){return res.arrayBuffer();})
    .then(function(buf){return new File([buf], fileName, {type:mimeType});})
  );
}

//create the map
function initMap() {
  console.log('initializing markers');
  let dishArray = [];
  db.collection('restaurants').get().then((snapshot) => {
    snapshot.docs.forEach(doc => {
      var restaurantData = doc.data();
      let marker = addRestMarker(restaurantData);
      marker.addTo(mymap);
      let restaurantDishes = restaurantHash[restaurantData.name];
      restaurantDishes = restaurantDishes || [];
      restaurantData.dishes.forEach(data => {
        dishArray.push(data.dish);
        restaurantDishes.push(data.dish);
      });
      restaurantHash[restaurantData.name] = [...(new Set(restaurantDishes))].sort();
    });
  }).then(() => {
    dishArray = [...(new Set(dishArray))].sort();
    autocomplete2(document.getElementById("dishInput"), dishArray);
  });
}

function initNewMarker(restaurantData) {
  console.log("****initNewMarker", restaurantData);
  let dishArray = [];
  let marker = addRestMarker(restaurantData);
  marker.addTo(mymap);
  let restaurantDishes = restaurantHash[restaurantData.name];
  restaurantDishes = restaurantDishes || [];
  restaurantData.dishes.forEach(data => {
    dishArray.push(data.dish);
    restaurantDishes.push(data.dish);
  });
  restaurantHash[restaurantData.name] = [...(new Set(restaurantDishes))].sort();
  dishArray = [...(new Set(dishArray))].sort();
  autocomplete2(document.getElementById("dishInput"), dishArray);
}

function initializeRestaurantsOnLoad() {
  console.log("window load");
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
    .then(function(registration) {
      console.log('serviceWorker Registered');
    })
    .catch(function(error) {
      console.log('serviceWorker Registration failed: ', error);
    });
    navigator.serviceWorker.ready.then( () => {
      console.log("serviceWorker ready");
    })
  }
}

function upload() {
  uploadTags();
  if (helloMessageInput.value.length == 0) {
    helloMessageOutput.innerText = "Looks like you haven't provided a review";
    return;
  }
  else {
    helloMessage = helloMessageInput.value;
  }
  var metadata = {
    contentType: 'image/jpeg'
  };
  const imagePaths = [];
  const storageRef = storage.ref();
  for (let key of Object.keys(miniFiles)) {
    let img = miniFiles[key];
    let fileRef = storageRef.child(img.name);
    fileRef.put(img).on(firebase.storage.TaskEvent.STATE_CHANGED, // or 'state_changed'
      function(snapshot) {
        // Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
        var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
        helloMessageOutput.innerText = `Uploading Receipt ...`;
        console.log('Upload is ' + progress + '% done');
        makeProgress(Math.round(progress));
        switch (snapshot.state) {
          case firebase.storage.TaskState.PAUSED: // or 'paused'
          console.log('Upload is paused');
          break;
          case firebase.storage.TaskState.RUNNING: // or 'running'
          console.log('Upload is running');
          break;
        }
      }, function(error) {
        switch (error.code) {
          case 'storage/unauthorized':
          // User doesn't have permission to access the object
          break;

          case 'storage/canceled':
          // User canceled the upload
          break;

          case 'storage/unknown':
          // Unknown error occurred, inspect error.serverResponse
          break;
        }
      }, function() {
        fileRef.getDownloadURL().then(function(singleImgPath) {
          imagePaths[key] = singleImgPath;
          if (Object.keys(imagePaths).length == Object.keys(miniFiles).length) {
            addReceiptToDB(imagePaths);
            addRestaurantToDB(imagePaths['dish'] || "");
            //
            // if (storageAvailable('localStorage')) {
            //   localStorage.removeItem("dish");
            //   localStorage.removeItem("receipt");
            // }
            //
            // delete miniFiles["dish"];
            // delete miniFiles["receipt"];
            // document.getElementById('dishPicturePreview').src = "https://mdbootstrap.com/img/Photos/Others/placeholder.jpg";
            // document.getElementById('receiptPicturePreview').src = "https://mdbootstrap.com/img/Photos/Others/placeholder-avatar.jpg";
          }
        });
      }
    )
  }
}

function addRestaurantToDB(dishImgURL) {
  let restaurantInputValue = restaurantInput.value.trim();
  let currentLat = currentLeaflet.getLatLng().lat;
  let currentLng = currentLeaflet.getLatLng().lng;
  let uploadCuisine = document.getElementById('indexCuisines').value;
  let dishes = {
    dish: dishInput.value,
    fileURL: dishImgURL,
    category: category,
    tags: ($('#indexIngredients').val().split(","))
  };
  let newRestaurant = {
    name: restaurantInputValue,
    adr: "",
    location: [currentLat, currentLng],
    dishes: [dishes],
    coupon:  10,
    cuisines: [uploadCuisine]
  };
  //if user has not modified restaurant input field
  if(isNewRestaurant) {
    //console.log("***`${currentUploadRestaurant.name}, ${currentUploadRestaurant.adr}`==", `${currentUploadRestaurant.name}, ${currentUploadRestaurant.adr}`);
    //console.log("***restaurantInputValue", restaurantInputValue);
    console.log("***isNewRestaurant", isNewRestaurant);
    db.collection("restaurants").add(newRestaurant);
  } else {
    console.log("***isNewRestaurant", isNewRestaurant);
    db.collection("restaurants")
    .where("name", "==", currentUploadRestaurant.name.trim())
    .where("adr", "==", currentUploadRestaurant.adr.trim())
    .get().then(querySnapshot => {
      console.log("***querySnapshot", querySnapshot.docs.length);
      if (querySnapshot.docs.length) {
        querySnapshot.forEach(function(doc) {
          var restaurantData = doc.data();
          var couponRemains = doc.data().coupon;
          var getCoupon = false;
          if(couponRemains > 0){
            couponRemains -= 1;
            getCoupon = true;
          }
          db.collection("restaurants").doc(doc.id).update({
            dishes: firebase.firestore.FieldValue.arrayUnion(dishes),
            coupon:  couponRemains,
            cuisines: firebase.firestore.FieldValue.arrayUnion(uploadCuisine)
          });
        })
      } else {
        // adding known restaurants on file but not in DB yet
        newRestaurant.name = currentUploadRestaurant.name.trim();
        newRestaurant.adr = currentUploadRestaurant.adr.trim();
        db.collection("restaurants").add(newRestaurant)
        .then(function(docRef) {
          console.log("Adding restaurant on file:", docRef.id);
          initNewMarker(newRestaurant);
        })
        .catch(function(error) {
          console.error("Error adding document: ", error);
        });
      }
    })
  }
}

function addReceiptToDB(imagePaths) {
  let currentLat = currentLeaflet.getLatLng().lat;
  let currentLng = currentLeaflet.getLatLng().lng;
  let uploadCuisine = document.getElementById('indexCuisines').value;
  let restaurantInputValue = restaurantInput.value.trim();
  let receiptImgURL = imagePaths["receipt"] || "";
  let dishImgURL = imagePaths["dish"] || "";

  db.collection("receipts").add({
    //email: emailInput.value,
    helloMessage: helloMessage,
    fileURL: dishImgURL,
    receiptImgURL: receiptImgURL,
    dish: dishInput.value,
    location: [currentLat, currentLng],
    restaurant: restaurantInputValue,
    dishImageName: dishImageFileName,
    receiptImageName: receiptImageFileName,
    tags: ($('#indexIngredients').val().split(",")),
    approved: false,
    category: category,
    cuisine: uploadCuisine
  })
  .then(function(docRef) {
    console.log("Receipt written with ID: ", docRef.id);
    helloMessageOutput.innerText = `File received with ID: ${docRef.id}`;
  })
  .catch(function(error) {
    console.error("Error adding document: ", error);
    helloMessageOutput.innerText = `Error adding document: ${error}`;
  });
}

function isAccurate(pos1, pos2) {
    var latDiff = Math.abs(pos1[0] - pos2[0]);
    var lngDiff = Math.abs(pos1[1] - pos2[1]);
    return (latDiff < 0.0001 && lngDiff < 0.0001);
}

</script>
</body>
</html>
