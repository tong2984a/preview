<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Hello, Vegan!</title>
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/sidebar.css">
  <link href="css/selectbox.css" rel="stylesheet">
  <link href="css/autocomplete.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
   integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
   crossorigin=""/>
   <!-- Make sure you put this AFTER Leaflet's CSS -->
 <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
   integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
   crossorigin=""></script>
   <style>
   #mapid { height: 360px; }
   </style>
</head>
<body>

  <div class="container">
    <div class="jumbotron">
      <p class="text-center">
        <a href="main.html">
          <img src="images/i128x128.png" class="img-responsive" style="margin:0 auto;" alt="Responsive image">
        </a>
      </p>
      <h1 class="text-center">Hello World!</h1>
      <p class="text-center">
        A simple hello could lead to a million things
      </p>
    </div>

    <!-- Message input field -->
    <div class="row justify-content-center">
      <div class="col-sm-6 form-group">
        <input type="text"
        class="form-control input-lg"
        id="emailInput"
        placeholder="Enter your email here...">
      </div>
    </div>

<div id="mapid"></div>

    <!-- Ricardo: input location-->
    <div id="mapSection" style="display: none;">
      <div id="sidebar-wrapper">
        <div id="toggle-btn" onclick="toggleSidebar()">
          <div></div>
          <div></div>
          <div></div>
        </div>
        <div id="sidebar">
          <h3 id="restaurantName">Restaurant</h3>
          <h4 id="restName"></h4>
          <hr>
          <h3 id="restaurantLocation">location</h3>
          <h4 id="restLocation"></h4>
          <h3>Dishes</h3>
          <div id="restaurantDish">
            <div id="slideContainer"></div>
            <div class="dotSection">
              <span class="dot"></span>
            </div>
          </div>
        </div>
      </div>
      <div id="map" style="width: 100%; height: 70vh;"></div>
    </div>
    <div class="row justify-content-center">
      <div class="col-sm-6">
        <p id="instruction" style="display: none;">Please drag the red pin to the place you want to choose</p>
        <input type="url" id="locationInput" class="form-control input-lg" style="display: none;" >
        <p><label id="locationLabel" for="locationInput" class="btn btn-primary my-2 btn-default btn-block btn-lg" style="display: none;" onclick="getCurrentLocation()">Set Location</label></p>
        <input type="text" id="address" class="form-control input-lg" style="display: none;">

        <p><label id="addressConfirm" for="address" class="btn btn-primary my-2 btn-default btn-block btn-lg" style="cursor: pointer;display: none;">Confirm Address</label></p>
      </div>
    </div>
    <!-- Ricardo: input restaurant -->
  <div id="after-location-loaded">
    <div class="row justify-content-center">
      <div class="col-sm-6 form-group">
        <div class="autocomplete">
          <input type="text"
          class="form-control input-lg"
          id="restaurantInput"
          placeholder="What is the name of the restaurant?"
          >
        </div>
      </div>
    </div>

    <!-- Ricardo: input dish -->
    <div class="row justify-content-center">
      <div class="col-sm-6 form-group">
        <input type="text"
        class="form-control input-lg"
        id="dishInput"
        placeholder="What is the name of the dish?">
      </div>
    </div>

    <div class="row justify-content-center">
      <div class="col-sm-6 form-group">
        <input type="text"
        class="form-control input-lg"
        id="helloMessageInput"
        placeholder="Enter your Review Message here...">
      </div>
    </div>

    <div class="row justify-content-center">
      <img id="preview" src="" />
    </div>
    <div class="row justify-content-center" >
      <input type="file" id="customFile" accept="image/*" style="display: none;" onChange="readURL(this)">
      <p><label id="uploadLabel" for="customFile" class="btn btn-primary my-2 btn-default btn-block btn-lg" style="cursor: pointer;">Upload Image</label></p>
    </div>
  </div>

    <!-- Ricardo Re-upload button -->
    <div class="row justify-content-center">
      <div class="col-xs-12">
        <button id="reUploadBtn" class="btn btn-success my-2 btn-default btn-block btn-lg" style="display: none;" onClick="reUpload()">
          Re-Upload Photo
        </button>

      </div>
    </div>

    <div class="row justify-content-center">
      <div class="col-xs-12" id="tags" style="display: none;">
        <div id="selectbox-container">
          <form>
            <label for="name">Category:</label>
            <select name="" id="categories">
              <option value="">Please Select</option>
            </select>
            <label for="name">Ingredient:</label>
            <input type="text" id="name" placeholder="Enter an ingredient">

            <button id="btnAdd">Add</button>

            <label for="list">Ingredient List:</label>
            <select id="list" name="list" multiple>

            </select>
            <button id="btnRemove">Remove Selected Ingredient</button>
          </form>
        </div>

        <script>
          const btnAdd = document.querySelector('#btnAdd');
          const btnRemove = document.querySelector('#btnRemove');
          const sb = document.querySelector('#list');
          const name = document.querySelector('#name');
          //Regex for Valid Characters i.e. Alphabets and Numbers.
          const regex = /^[A-Za-z\s]+$/

          btnAdd.onclick = (e) => {
            e.preventDefault();

            // validate the option
            if (name.value == '') {
              alert('Please enter the name.');
              return;
            }

            //Validate TextBox value against the Regex.
            var isValid = regex.test(name.value);
            if (!isValid) {
                alert("Only Alphabets and Numbers allowed.");
            }

            // create a new option
            const option = new Option(name.value, name.value);
            // add it to the list
            sb.add(option, undefined);

            // reset the value of the input
            name.value = '';
            name.focus();
          };

          // remove selected option
          btnRemove.onclick = (e) => {
            e.preventDefault();

            // save the selected option
            let selected = [];

            for (let i = 0; i < sb.options.length; i++) {
              selected[i] = sb.options[i].selected;
            }

            // remove all selected option
            let index = sb.options.length;
            while (index--) {
              if (selected[index]) {
                sb.remove(index);
              }
            }
          };
        </script>
      </div>
    </div>

    <!-- Ricardo tags-->
    <div class="row justify-content-center" >
      <div class="col-xs-12 btn-group-toggle" id="tags" style="display: none;">
        <input type="checkbox" id="gluten-free" name="">
        <label for="gluten-free">Gluten-free</label>
        <input type="checkbox" id="egg-free" name="">
        <label for="egg-free">Egg-free</label>
        <br>
        <input type="checkbox" id="dairy-free" name="">
        <label for="dairy-free">Dairy-free</label>
        <input type="checkbox" id="treenut-free" name="">
        <label for="treenut-free">Treenut-free</label>
        <br>
        <input type="checkbox" id="peanut-free" name="">
        <label for="peanut-free">Peanut-free</label>
        <input type="checkbox" id="soy-free" name="">
        <label for="soy-free">Soy-free</label>
        <br>
        <input type="checkbox" id="raw" name="">
        <label for="raw">Raw</label>
        <input type="checkbox" id="vegan" name="">
        <label for="vegan">Vegan</label>
        <br>
        <input type="checkbox" id="buddhist-friendly" name="">
        <label for="buddhist-friendly">Buddhist-friendly</label>
        <input type="checkbox" id="all-natural" name="">
        <label for="all-natural">All natural</label>
      </div>
    </div>

    <!-- Send button -->
    <div class="row justify-content-center">
      <div class="col-xs-12">
        <button id="sendBtn" class="btn btn-success my-2 btn-default btn-block btn-lg" style="display: none;" onClick="upload()">
          Send
        </button>
      </div>
    </div>

    <!-- Add another dish button -->
    <div class="row justify-content-center">
      <div class="col-xs-12">
        <button id="addBtn" class="btn btn-success my-2 btn-default btn-block btn-lg" style="display: none;" onClick="refreshMap()">
          Add another dish
        </button>
      </div>
    </div>
  </div>

  <div class="row justify-content-center">
    <a href="main.html">
      <label id="back" class="btn btn-primary my-2 btn-default btn-block btn-lg" style="cursor: pointer;">Back to Main</label>
    </a>
  </div>

  <hr>

  <!-- Place to show the latest message -->
  <h2 class="text-center"></h2>
  <h3 id="helloMessageOutput" class="text-center text-warning">
    <span class="text-info"></span>
  </h3>

  <div class="progress md-progress" style="height: 20px">
    <div id="progressBar" class="progress-bar progress-bar-striped bg-success" role="progressbar" style="width: 0%; height: 15px" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
  </div>
  <hr>
</div>

<script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-storage.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-analytics.js"></script>
<script defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAEJpg61U3rDVLKE9A0MZ-1i7F1FezKpTQ
        &libraries=visualization,places,geometry&callback=initMap">
        /*Maybe need to change to yours maps to makes it work, change the src above to
          https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap
          and replace the "YOUR_API_KEY" by an enabled google maps API key.
          The guide lines can be found in the link below.
          https://developers.google.com/maps/documentation/javascript/get-api-key
        */
</script>
<script src="js/JIC.min.js" type="text/javascript"></script>
<script src="js/jquery-3.5.1.min.js"></script>
<script src="js/autocomplete.js"></script>
<script defer src="js/mapHelper.js" type="text/javascript"></script>
<script>
//Ricardo: testing
showAvatar();
var mymap = L.map('mapid');

  $.getJSON("https://cors-anywhere.herokuapp.com/https://api.ipgeolocationapi.com/geolocate")
  .done(onLocationFound)
  .fail(onLocationError)
  .always(function(data) {
    console.log("always ");
    console.log(data);
  })

function onMapClick(e) {
  var popup = L.popup();
    popup
        .setLatLng(e.latlng)
        .setContent("You clicked the map at " + e.latlng.toString())
        .openOn(mymap);
}

	function onLocationFound(e) {
    currentLocation = [e.geo.latitude, e.geo.longitude]
    mymap.setView(currentLocation, 13);
    var radius = 1;
    L.tileLayer('https://maps.wikimedia.org/osm-intl/{z}/{x}/{y}{r}.png', {
        maxNativeZoom: 18,
        maxZoom: 20,
        attribution: '&copy; <a target="_blank" rel="noopener" href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors & <a target="_blank" rel="noopener" href="https://maps.wikimedia.org/">Wikimedia maps</a>'
    }).addTo(mymap);
    circle = L.circle(currentLocation, {
        color: 'red',
        fillColor: '#f03',
        fillOpacity: 0.5,
        radius: 500
    }).addTo(mymap);
    //marker.bindPopup("<b>Hello world!</b><br>I am a popup.").openPopup();
    let p = circle.bindPopup("You are here.").openPopup();
    setTimeout(function () {
        circle = L.circle(currentLocation, {
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.5,
            radius: 500
        }).addTo(mymap);
            p.removeFrom(mymap);
    }, 3000);
    mymap.on('click', onMapClick);
	}

	function onLocationError(e) {
    mymap.setView(currentLocation, 13);
        var radius = 1;

    		L.marker(currentLocation).addTo(mymap)
    			.bindPopup("You are within " + radius + " meters from this point").openPopup();

    		L.circle(currentLocation, radius).addTo(mymap);
        L.tileLayer('https://maps.wikimedia.org/osm-intl/{z}/{x}/{y}{r}.png', {
            maxNativeZoom: 18,
            maxZoom: 20,
            attribution: '&copy; <a target="_blank" rel="noopener" href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors & <a target="_blank" rel="noopener" href="https://maps.wikimedia.org/">Wikimedia maps</a>'
        }).addTo(mymap);

        var marker = L.marker([22.273, 114.163]).addTo(mymap);
        var circle = L.circle([22.278, 114.171], {
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.5,
            radius: 500
        }).addTo(mymap);
        var polygon = L.polygon([
            [22.279, 114.168],
            [22.273, 114.16],
            [22.271, 114.167]
        ]).addTo(mymap);
        marker.bindPopup("<b>Hello world!</b><br>I am a popup.").openPopup();
        circle.bindPopup("I am a circle.");
        polygon.bindPopup("I am a polygon.");
        mymap.on('click', onMapClick);
	}

//Ricardo: current
const firebaseConfig = {
    apiKey: "AIzaSyBg34hCq_jGHdj-HNWi2ZjfqhM2YgWq4ek",
    authDomain: "pay-a-vegan.firebaseapp.com",
    databaseURL: "https://pay-a-vegan.firebaseio.com",
    projectId: "pay-a-vegan",
    storageBucket: "pay-a-vegan.appspot.com",
    messagingSenderId: "587888386485",
    appId: "1:587888386485:web:3a81137924d19cbe2439fc",
    measurementId: "G-MGJK6GF9YW"
  };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
var storageRef = firebase.storage().ref();
var storage = firebase.storage();

// DOM element shortcuts.
var emailInput = document.getElementById('emailInput');
var helloMessageInput = document.getElementById('helloMessageInput');
var helloMessageOutput= document.getElementById('helloMessageOutput');
var preview= document.getElementById('preview');
var bar= document.getElementById('progressBar');
var miniFile = '';
// added in 15/7
var dishInput = document.getElementById('dishInput');
var searchInput = document.getElementById('searchInput');
var restaurantInput = document.getElementById('restaurantInput');
var locationInput = document.getElementById('locationInput');
var map;
// added in 16/7
var defaultLocation = [22.3, 114.16];
var currentLocation = [22.276, 114.173];
var contentString = '<div>' +
                restaurantInput.value +
                '</div>' +
                '<div>' +
                dishInput.value +
                '</div>' +
                '<div>' +
                preview.value +
                '</div>' ;
// added in 17/7
var imageFileName;
// added in 20/7
var isGlutenFree;
var isEggFree;
var isDairyFree;
var isTreenutFree;
var isPeanutFree;
var isSoyFree;
var isRaw;
var isVegan;
var isBuddhistFriendly;
var isAllNatural;
var referenceID;
var tagList;
// added in 23/7
var imgURL;

var request = {
    query: restaurantInput.value,
    fields: ['name', 'formatted_address', 'geometry'],
  };
var service;
var blueIcon;
var greenIcon;

var markers = [];
var showing = [];
var circle;
var current;
var currentLeaflet;
var currentRestaurantId;
var newRestaurantId;
const mode = "add";

function visualizeArea(area) {
    console.log(area.name);
    var circle = new google.maps.Circle({      fillColor: "#FF0000",});
    circle.setCenter({lat: area.center[0], lng: area.center[1]});
    circle.setRadius(area.radius);
    circle.setVisible(true);
    circle.setMap(map)
}

function searchRestaurant(input) {
  console.log('searching ', input);
  service.findPlaceFromQuery(request, function(results, status) {
    if (status === google.maps.places.PlacesServiceStatus.OK) {
      for (var i = 0; i < results.length; i++) {
        createMarker(results[i]);
      }
      map.setCenter(results[0].geometry.location);
    }
  });
}

function makeProgress(i){
  bar.style.width = i+'%';
  bar.innerText = i+'%';
  bar.setAttribute('aria-valuenow', i);
}

function srcToFile(src, fileName, mimeType){
  return (fetch(src)
  .then(function(res){return res.arrayBuffer();})
  .then(function(buf){return new File([buf], fileName, {type:mimeType});})
);
}

function readURL(input) {
  if (input.files && input.files[0]) {
    var reader = new FileReader();
    var filesize = ((input.files[0].size/1024)/1024).toFixed(4);
    console.log(`Initial File : ${filesize} MB`);
    reader.onload = function(e) {
      var quality = 30;
      var output_format = "image/png";
      console.log("Quality >>" + quality);

      console.log("process start...");
      var time_start = new Date().getTime();

      var img = new Image();
      img.src = e.target.result;
      img.onload = function() {
        preview.src = jic.compress(img,quality,output_format).src;
        //15/7 fixing bug of same file name will caused replacing old image in firebase
        var dateTime = new Date();
        imageFileName = dateTime + ".jpg";
        srcToFile(
          preview.src,
          imageFileName,
          'jpg'
        )
        .then(function(file){
          miniFile = file;
          filesize = ((file.size/1024)/1024).toFixed(4);
          console.log(`Finished compressing : ${filesize} MB`)
        })

        preview.onload = function(){
          var image_width = preview.style.width,
          image_height = preview.style.height;

          if(image_width > image_height){
            preview.style.width="320px";
          }else{
            preview.style.height="300px";
          }
          preview.style.display = "block";
          document.getElementById('uploadLabel').style.display = "none";
          document.getElementById('sendBtn').style.display = "block";
          //Ricardo add re-upload button
          document.getElementById('reUploadBtn').style.display = "block";
          document.getElementById('tags').style.display = "block";
        }
        var duration = new Date().getTime() - time_start;

        console.log('Processed in: ' + duration + 'ms');
      }
    }

    reader.readAsDataURL(input.files[0]);
  } else {
    console.log("You must load an image first!");
  }
}

//Ricardo: re-upload
function reUpload() {
  document.getElementById('uploadLabel').style.display = "block";
  document.getElementById('sendBtn').style.display = "none";
  document.getElementById('reUploadBtn').style.display = "none";
  document.getElementById('tags').style.display = "none";
  preview.style.display = "none";
  console.log(preview);
}

//Ricardo: email validation
function ValidateEmail(mail) {
  var emailFormat = /^(?:[\w\!\#\$\%\&\'\*\+\-\/\=\?\^\`\{\|\}\~]+\.)*[\w\!\#\$\%\&\'\*\+\-\/\=\?\^\`\{\|\}\~]+@(?:(?:(?:[a-zA-Z0-9](?:[a-zA-Z0-9\-](?!\.)){0,61}[a-zA-Z0-9]?\.)+[a-zA-Z0-9](?:[a-zA-Z0-9\-](?!$)){0,61}[a-zA-Z0-9]?)|(?:\[(?:(?:[01]?\d{1,2}|2[0-4]\d|25[0-5])\.){3}(?:[01]?\d{1,2}|2[0-4]\d|25[0-5])\]))$/;
  return emailFormat.test(mail.value);
}

//create the map
function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: 22.3, lng: 114.2},
    zoom: 12,
    styles: [{
      featureType: 'poi',
      stylers: [{ visibility: 'off' }]  // Turn off points of interest.
    }, {
      featureType: 'transit.station',
      stylers: [{ visibility: 'off' }]  // Turn off bus stations, train stations, etc.
    }],
    disableDoubleClickZoom: true,
    streetViewControl: false
  });
  console.log('initializing map');
  db.collection('restaurants').get().then((snapshot) => {
    // console.log('snapshot:' + snapshot);
    snapshot.docs.forEach(doc => {
      var restaurantData = doc.data();
      // console.log(restaurantData);
      //console.log(restaurantData.location);
      addRestMarker(restaurantData, doc.id);
    });
  }).then(() => {
    newRestaurantId = (markers.length + 1);
    console.log("newRestaurantId:" + newRestaurantId);
    autocomplete(document.getElementById("restaurantInput"), markers);
  });

  service = new google.maps.places.PlacesService(map);
  //init localStorage
}
async function showAvatar() {

    var networkDataReceived = false;
    //await new Promise((resolve, reject) => setTimeout(resolve, 3000));
    // console.log("async1");
     await sw();
    // console.log("async2");
     await startspinner();
    // console.log("async3");
    // await stopspinner();
    // console.log("async4");
    // findImages();
}

async function findImages() {
  // Get a list of all of the caches for this origin
  const cacheNames = await caches.keys();
  const result = [];

  for (const name of cacheNames) {
    // Open the cache
    const cache = await caches.open(name);

    // Get a list of entries. Each item is a Request object
    for (const request of await cache.keys()) {
      // If the request URL matches, add the response to the result
      // if (request.url.endsWith('.png')) {
      //   result.push(await cache.match(request));
      // }
      console.log("request.url");
      console.log(request.url);
    }
  }

  return result;
}

async function stopspinner() {
  const response = await caches.match('/data/sort-veggie.json');
  console.log(request, response);
  const reader = await response.json();

  console.log(reader);

  console.log("stopping");
}

async function stopspinner2() {
console.log("stopSpinner");
        // fetch cached data
        caches.match('/data/sort-veggie.json').then(function(response) {
          console.log("match");
          console.log(response.json());
          if (!response) throw Error("No data");
          return response.json();
        }).then(function(data) {
          // don't overwrite newer network data
        //  if (!networkDataReceived) {
            console.log("stopspinner(data)");
            console.log(data);
        //  }
        }).catch(function() {
          // we didn't get cached data, the network is our last hope:
          //return networkUpdate;
          console.log("no cacha");
          return "no cached data";
        }).catch(console.log("showErrorMessage")).then(console.log("stopSpinner"));

}

async function startspinner() {
  // fetch fresh data
  var networkUpdate = await fetch('/data/sort-veggie.json').then(function(response) {
    console.log("networkUpdate");
    return response.json();
  }).then(function(data) {
    networkDataReceived = true;
    console.log("startspinner(data)");
    console.log(data);
    let itemsArray = data.map(item => {
      return { "name": item.SS, "dist": item.DIST, "adr": item.ADR, "lat": currentLocation[0], "lng": currentLocation[1] }
    })

    itemsArray.push({name:'LOVING HUT 愛家國際餐飲 - 淘大店', dist: '51', adr: 'SHOP NOS. G242-245, G/F, AMOY PLAZA , PHASE II, 77 NGAU TAU KOK ROAD, KOWLOON', lat:22.323897, lng:114.216543});
    itemsArray.push({name:'LOVING HUT 愛家 - Port 33 分店', dist: '53', adr: 'SHOP 103A, 1/F, PORT 33, 33 TSEUK LUK STREET, SAN PO KONG, KOWLOON', lat:22.3355, lng:114.197718});
    itemsArray.push({name:'Vegan Seven Days', dist: '52', adr: 'G/F, 22C SUNG KIT STREET, HUNG HOM, KOWLOON', lat:22.311779, lng:114.188552});
    itemsArray.push({name:'POP Vegan', dist: '18', adr: 'SHOP 1, 1ST FLOOR, MILLION CITY, NO. 28 ELGIN STREET, CENTRAL, HONG KONG', lat:22.281855, lng:114.152563});
    itemsArray.push({name:'10 ST. FRANCIS', dist: '12', adr: 'G/F., 10 ST. FRANCIS STREET, WANCHAI, HONG KONG', lat:22.276165, lng:114.169578});
    itemsArray.push({name:'MANA! Starstreet', dist: '12', adr: 'G/F., 6 HENNESSY ROAD, HONG KONG', lat:22.27774, lng:114.16842});
    itemsArray.push({name:'MANA! SOHO', dist: '18', adr: 'G/F., NO. 6-8 STAUNTON STREET, CENTRAL, HONG KONG', lat:22.28162, lng:114.153091});
    itemsArray.push({name:'Feather and Bone', dist: '18', adr: 'SHOP 1A ON G/F., COMMERCIAL ACCOMMODATION, BOHEMIAN HOUSE, 321 DES VOEUX ROAD WEST, HONG KONG', lat:22.287606, lng:114.138868});
    itemsArray.push({name:'Feather and Bone', dist: '12', adr: 'THE PORTION A OF SHOP A &amp; C, G/F., WINNER BUILDING, NO. 11 WONG NAI CHUNG ROAD, HAPPY VALLEY, HONG KONG', lat:22.269535, lng:114.184088});
    itemsArray.push({name:'Feather and Bone', dist: '12', adr: 'SHOP A, G/F., LUARD ON THE PARK, 5 LUARD ROAD, WAN CHAI, HONG KONG', lat:22.276861, lng:114.171361});
    itemsArray.push({name:'Feather and Bone', dist: '92', adr: 'MAJOR PORTION OF SHOP NOS. G09 AND GO9A, G/F, OP MALL, 100 TAI HO ROAD, TSUEN WAN, NEW TERRITORIES', lat:22.368085, lng:114.110658});
    itemsArray.push({name:'Feather and Bone', dist: '18', adr: 'SHOP ON SHOP LEVEL 1 FLOOR, SOHO 38, NO. 38 SHELLEY STREET, HONG KONG', lat:22.280023, lng:114.151251});
    itemsArray.push({name:'Mana! Fast Slow Food', dist: '18', adr: 'G/F., 92 WELLINGTON STREET, CENTRAL, HONG KONG', lat:22.282801, lng:114.154556});
    itemsArray.push({name:'Fuel Espresso', dist: '18', adr: 'SHOP 3023, LEVEL 3, IFC MALL, CENTRAL, HONG KONG', lat:22.284943, lng:114.157324});
    itemsArray.push({name:'Fuel Espresso', dist: '18', adr: 'TWO DESIGNATED SEATING AREAS OPPOSITE TO SHOP B47A AND SHOP B47A, FIRST BASEMENT FLOOR, LANDMARK ATRIUM, 15 QUEEN&apos;S ROAD CENTRAL, CENTRAL, HONG KONG', lat:22.280676, lng:114.157692});
    itemsArray.push({name:'Fuel Espresso', dist: '18', adr: 'SHOP 206 AND AREA A, LEVEL 2, PACIFIC PLACE, 88 QUEENSWAY, HONG KONG', lat:22.277152, lng:114.164887});
    itemsArray.push({name:'Fuel Espresso', dist: '18', adr: 'PORTION OF OFFICE LOBBY AT G/F, CHATER HOUSE, 8 CONNAUGHT ROAD CENTRAL, CENTRAL, HONG KO', lat:22.282126, lng:114.15847});
    itemsArray.push({name:'Fuel Espresso', dist: '11', adr: 'AREA A, G/F., ONE TAIKOO PLACE, TAIKOO PLACE, 979 KING&apos;S ROAD, QUARRY BAY, HONG KONG', lat:22.287192, lng:114.211008});
    itemsArray.push({name:'Fuel Espresso', dist: '61', adr: 'SHOP B, LOBBY OF SKY OBSERVATION DECK, 2/F, ICC, 1 AUSTIN ROAD WEST, KOWLOON', lat:22.303381, lng:114.160231});
    itemsArray.push({name:'FUEL ESPRESSO QUAYSIDE', dist: '51', adr: 'SHOP NO.2, GROUND FLOOR, TOWER 1 AND TOWER 2, THE QUAYSIDE, 77 HOI BUN ROAD, KWUN TONG, KOWLOON', lat:22.316534, lng:114.213709});

    localStorage.setItem('restaurants', JSON.stringify(itemsArray));
  })
}

async function sw() {
  console.log("sw");
  if ('serviceWorker' in navigator) {
    await navigator.serviceWorker.register('service-worker.js')
    .then(function(registration) {
      console.log('Registered:', registration);
    })
    .catch(function(error) {
      console.log('Registration failed: ', error);
    });
  }
}
//helper function
//function addToList(tagName, id) {
//  console.log('add id' + id);
//  db.collection('tagLists').doc(tagName).update({
//    docID: firebase.firestore.FieldValue.arrayUnion(id)
//  });
//}

function upload() {
  uploadTags();
  if (emailInput.value.length == 0) {
    helloMessageOutput.innerText = "Looks like you haven't provided an email";
    return;
  }
  //Ricardo: check for invalid email
  if (!ValidateEmail(emailInput)) {
    helloMessageOutput.innerText = "You have entered an invalid email address!";
    return;
  }
  if (helloMessageInput.value.length == 0) {
    helloMessageOutput.innerText = "Looks like you haven't provided a review";
    return;
  }
  else {
    helloMessage = helloMessageInput.value;
  }

  //var file = document.getElementById('preview').files[0];

  var metadata = {
    contentType: 'image/jpeg'
  };

  var uploadTask = storageRef.child('images/' + miniFile.name).put(miniFile, metadata);

  // Listen for state changes, errors, and completion of the upload.
  uploadTask.on(firebase.storage.TaskEvent.STATE_CHANGED, // or 'state_changed'
    function(snapshot) {
      // Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
      var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
      helloMessageOutput.innerText = `Uploading Receipt ...`;
      console.log('Upload is ' + progress + '% done');
      makeProgress(Math.round(progress));
      switch (snapshot.state) {
        case firebase.storage.TaskState.PAUSED: // or 'paused'
        console.log('Upload is paused');
        break;
        case firebase.storage.TaskState.RUNNING: // or 'running'
        console.log('Upload is running');
        break;
      }
    }, function(error) {
      // A full list of error codes is available at
      // https://firebase.google.com/docs/storage/web/handle-errors
      switch (error.code) {
        case 'storage/unauthorized':
        // User doesn't have permission to access the object
        break;

        case 'storage/canceled':
        // User canceled the upload
        break;

        case 'storage/unknown':
        // Unknown error occurred, inspect error.serverResponse
        break;
      }
    }, function() {
      // Upload completed successfully, now we can get the download URL
      console.log("currentLeaflet getLatLng");
      console.log(currentLeaflet.getLatLng());
      let currentLat = currentLeaflet.getLatLng().lat;
      let currentLng = currentLeaflet.getLatLng().lng;
      uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL) {
        db.collection("receipts").add({
          email: emailInput.value,
          helloMessage: helloMessage,
          fileURL: imgURL = downloadURL,
          //15/7 add
          dish: dishInput.value,
          //location: [current.position.lat(), current.position.lng()],
          location: [currentLat, currentLng],
          restaurant: restaurantInput.value,
          //17/7 add
          imageName: imageFileName,
          tags: tagList,
          //31/7 add
          approved: false,
          category: category,

        })
        .then(function(docRef) {
          console.log("Document written with ID: ", docRef.id);
          helloMessageOutput.innerText = `File received with ID: ${docRef.id}`;
          console.log("refresh the map");
          console.log(newRestaurantId);
          //newMarker();
          newRestaurantId = docRef.id;
          var dishes = {
            dish: dishInput.value,
            fileURL: imgURL,
            category: category,
            tags: tagList
          };
          console.log(currentRestaurantId);
          if(currentRestaurantId){
            console.log(currentRestaurantId);
            db.collection("restaurants").doc(currentRestaurantId.toString()).get().then((doc) => {
            console.log(doc.exists);
              if(doc.exists){
                console.log('exist');
                var couponRemains = doc.data().coupon;
                var getCoupon = false;
                if(couponRemains > 0){
                  console.log('get coupon');
                  couponRemains -= 1;
                  getCoupon = true;
                }
                console.log(currentLocation);
                console.log(doc.data().location);
                if(isAccurate(currentLocation, doc.data().location)){
                  console.log('accurate');
                  addToRestaurant(dishes, couponRemains, getCoupon);
                }else{
                  //addNewRestaurant(dishes);
                }
              }else{
                //addNewRestaurant(dishes);
              }
            })
          }else{
            //addNewRestaurant(dishes);
          }
        })
        .catch(function(error) {
          console.error("Error adding document: ", error);
          helloMessageOutput.innerText = `Error adding document: ${error}`;
        });

      });
    }
  );
    document.getElementById("addBtn").style.display = "block";
}

function isAccurate(pos1, pos2) {
    var latDiff = Math.abs(pos1[0] - pos2[0]);
    var lngDiff = Math.abs(pos1[1] - pos2[1]);
    return (latDiff < 0.0001 && lngDiff < 0.0001);
}

function addToRestaurant(dish, couponRemains, getCoupon) {
  db.collection('restaurants').doc(currentRestaurantId.toString()).update({
      dishes: firebase.firestore.FieldValue.arrayUnion(dish),
      coupon:  couponRemains
  });
  if(getCoupon)alert('You get a coupon');
}

function addNewRestaurant(dishes) {
  console.log('not exist');
  var initArray = [];
  db.collection("restaurants").doc(newRestaurantId.toString()).set({
    name: restaurantInput.value,
    location: currentLocation,
    dishes: initArray,
    id: newRestaurantId,
    coupon: 0
  }).then(
    db.collection('restaurants').doc(newRestaurantId.toString()).update({
        dishes: firebase.firestore.FieldValue.arrayUnion(dishes),
    })
  );
}

</script>
<!-- make map -->

</body>
</html>
