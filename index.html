<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Hello, Vegan!</title>
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/sidebar.css">

</head>
<body>

  <div class="container">
    <div class="jumbotron">
      <p class="text-center">
        <a href="main.html">
          <img src="images/i128x128.png" class="img-responsive" style="margin:0 auto;" alt="Responsive image">                
        </a>
      </p>
      <h1 class="text-center">Hello World!</h1>
      <p class="text-center">
        A simple hello could lead to a million things
      </p>
    </div>

    <!-- Message input field -->
    <div class="row justify-content-center">
      <div class="col-sm-6 form-group">
        <input type="text"
        class="form-control input-lg"
        id="emailInput"
        placeholder="Enter your email here...">
      </div>
    </div>

    <!-- Ricardo: input location-->
    <div id="mapSection"  style="display: none;"">
      <div id="sidebar-wrapper">                   
          <div id="toggle-btn" onclick="toggleSidebar()">
              <div></div>
              <div></div>
              <div></div>
          </div>
          <div id="sidebar">            
              <h3 id="restaurantName">Restaurant</h3>
              <h4 id="restName"></h4>
              <hr>
              <h3 id="restaurantLocation">location</h3>
              <h4 id="restLocation"></h4>
              <h3>Dishes</h3>
              <div id="restaurnatDish">                                
                  <div id="slideContainer"></div>                      
                  <div class="dotSection">
                      <span class="dot"></span>
                  </div>
              </div>
          </div>
      </div>
      <div id="map" style="width: 100%; height: 70vh;"></div>
  </div>
    <div class="row justify-content-center">
      <div class="col-sm-6 form-group">        
        <p id="instruction" style="display: none;">Please drag the red pin to the place you want to choose</p>
        <input type="url" id="locationInput" class="form-control input-lg" style="display: none;" >          
        <p><label id="locationLabel" for="locationInput" class="btn btn-primary my-2 btn-default btn-block btn-lg" style="cursor: pointer;" onclick="getCurrentLocation()">Set Location</label></p>      
        <input type="text" id="address" class="form-control input-lg" style="display: none;">

        <p><label id="addressConfirm" for="address" class="btn btn-primary my-2 btn-default btn-block btn-lg" style="cursor: pointer;display: none;">Confirm Address</label></p>
      </div>
    </div>
    <!-- Ricardo: input restaurant -->
    <div class="row justify-content-center">
      <div class="col-sm-6 form-group">
        <input type="text"
        class="form-control input-lg"
        id="searchInput"
        placeholder="Please enter the name of the restaurnt you want to find?"
        onchange="searchRestaurantDemo(this.value, 'add')">
        <input type="text"
        class="form-control input-lg"
        id="restaurantInput"
        placeholder="What is the name of the restaurnt?"
        >
        <h6 id="restSearch"></h6>
      </div>
    </div>
    <!-- Ricardo: input dish -->
    <div class="row justify-content-center">
      <div class="col-sm-6 form-group">
        <input type="text"
        class="form-control input-lg"
        id="dishInput"
        placeholder="What is the name of the dish?">
      </div>
    </div>   
    <div class="row justify-content-center">
      <div class="col-sm-6 form-group">
        <input type="text"
        class="form-control input-lg"
        id="helloMessageInput"
        placeholder="Enter your Hello Message here...">
      </div>
    </div>
    <div class="row justify-content-center">
      <img id="preview" src="" />
    </div>
    <div class="row justify-content-center">
      <input type="file" id="customFile" accept="image/*" style="display: none;" onChange="readURL(this)">
      <p><label id="uploadLabel" for="customFile" class="btn btn-primary my-2 btn-default btn-block btn-lg" style="cursor: pointer;">Upload Image</label></p>
    </div>

    <!-- Ricardo Re-upload button -->
    <div class="row justify-content-center">
      <div class="col-xs-12 form-group">
        <button id="reUploadBtn" class="btn btn-success my-2 btn-default btn-block btn-lg" style="display: none;" onClick="reUpload()">
          Re-Upload Photo
        </button>
      </div>
    </div>

    <div class="row justify-content-center">
      <div class="col-xs-12 form-group" id="tags" style="display: none;">
        <select name="" id="categories" onchange="loadTags(this.value)">
          <option value="">Please Select</option>
        </select>
        <div id="selectTags">
    
        </div>
        <input type="checkbox" id="newTag" class="checkbox">
        <input type="text" id="newTagName">
      </div>
    </div>

    <!-- Ricardo tags-->
    <div class="row justify-content-center" >
      <div class="col-xs-12 btn-group-toggle" id="tags" style="display: none;">
        <input type="checkbox" id="gluten-free" name="">
        <label for="gluten-free">Gluten-free</label>
        <input type="checkbox" id="egg-free" name="">
        <label for="egg-free">Egg-free</label>
        <br>
        <input type="checkbox" id="dairy-free" name="">
        <label for="dairy-free">Dairy-free</label>
        <input type="checkbox" id="treenut-free" name="">
        <label for="treenut-free">Treenut-free</label>
        <br>
        <input type="checkbox" id="peanut-free" name="">
        <label for="peanut-free">Peanut-free</label>
        <input type="checkbox" id="soy-free" name="">
        <label for="soy-free">Soy-free</label>
        <br>
        <input type="checkbox" id="raw" name="">
        <label for="raw">Raw</label>        
        <input type="checkbox" id="vegan" name="">
        <label for="vegan">Vegan</label>
        <br>
        <input type="checkbox" id="buddhist-friendly" name="">
        <label for="buddhist-friendly">Buddhist-friendly</label>        
        <input type="checkbox" id="all-natural" name="">
        <label for="all-natural">All natural</label>
      </div>
    </div>

    <!-- Send button -->
    <div class="row justify-content-center">
      <div class="col-xs-12 form-group">
        <button id="sendBtn" class="btn btn-success my-2 btn-default btn-block btn-lg" style="display: none;" onClick="upload()">
          Send
        </button>
      </div>
    </div>

    <!-- Add another dish button -->
    <div class="row justify-content-center">
      <div class="col-xs-12 form-group">
        <button id="addBtn" class="btn btn-success my-2 btn-default btn-block btn-lg" style="display: none;" onClick="refreshMap()">
          Add another dish
        </button>
      </div>
    </div>
  </div>

  <div class="row justify-content-center">
    <a href="main.html">
      <label id="back" class="btn btn-primary my-2 btn-default btn-block btn-lg" style="cursor: pointer;">Back to Main</label>
    </a>
  </div>

  <hr>

  <!-- Place to show the latest message -->
  <h2 class="text-center"></h2>
  <h3 id="helloMessageOutput" class="text-center text-warning">
    <span class="text-info"></span>
  </h3>

  <div class="progress md-progress" style="height: 20px">
    <div id="progressBar" class="progress-bar progress-bar-striped bg-success" role="progressbar" style="width: 0%; height: 15px" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
  </div>
  <hr>
</div>

<script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-storage.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-analytics.js"></script>
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAEJpg61U3rDVLKE9A0MZ-1i7F1FezKpTQ
        &libraries=visualization,places,geometry&callback=initMap">
        /*Maybe need to change to yours maps to makes it work, change the src above to 
          https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap
          and replace the "YOUR_API_KEY" by an enabled google maps API key.
          The guide lines can be found in the link below.
          https://developers.google.com/maps/documentation/javascript/get-api-key
        */
</script>
<script async defer src="js/JIC.min.js" type="text/javascript"></script>
<script async defer src="js/jquery-3.5.1.min.js"></script>
<script async defer src="js/mapHelper.js" type="text/javascript"></script>


<script>
//Ricardo: testing

//Ricardo: current
const firebaseConfig = {
    apiKey: "AIzaSyAbxF9mc46KksOqqJmS3oOwjjDsW2cy8_k",
    authDomain: "pav-recipt.firebaseapp.com",
    databaseURL: "https://pav-recipt.firebaseio.com",
    projectId: "pav-recipt",
    storageBucket: "pav-recipt.appspot.com",
    messagingSenderId: "677673489684",
    appId: "1:677673489684:web:e61952268b8d6c45fdde01",
    measurementId: "G-PCXD5E1428"
  };
  
/*var firebaseConfig = {
  apiKey: "AIzaSyBg34hCq_jGHdj-HNWi2ZjfqhM2YgWq4ek",
  authDomain: "pay-a-vegan.firebaseapp.com",
  databaseURL: "https://pay-a-vegan.firebaseio.com",
  projectId: "pay-a-vegan",
  storageBucket: "pay-a-vegan.appspot.com",
  messagingSenderId: "587888386485",
  appId: "1:587888386485:web:3a81137924d19cbe2439fc",
  measurementId: "G-MGJK6GF9YW"
};*/
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
var storageRef = firebase.storage().ref();
var storage = firebase.storage();

// DOM element shortcuts.
var emailInput = document.getElementById('emailInput');
var helloMessageInput = document.getElementById('helloMessageInput');
var helloMessageOutput= document.getElementById('helloMessageOutput');
var preview= document.getElementById('preview');
var bar= document.getElementById('progressBar');
var miniFile = '';
// added in 15/7
var dishInput = document.getElementById('dishInput');
var searchInput = document.getElementById('searchInput');
var restaurantInput = document.getElementById('restaurantInput');
var locationInput = document.getElementById('locationInput');
var map;
// added in 16/7
var defaultLocation = [22.3, 114.16];
var currentLocation = [22.3, 114.16];
var contentString = '<div>' +
                restaurantInput.value +
                '</div>' +
                '<div>' +
                dishInput.value +
                '</div>' +
                '<div>' +
                preview.value +
                '</div>' ;
// added in 17/7
var imageFileName;
// added in 20/7
var isGlutenFree;
var isEggFree;
var isDairyFree;
var isTreenutFree;
var isPeanutFree;
var isSoyFree;
var isRaw;
var isVegan;
var isBuddhistFriendly;
var isAllNatural;
var referenceID;
var tagList;
// added in 23/7
var imgURL;

var request = {
    query: searchInput.value,
    fields: ['name', 'formatted_address', 'geometry'],
  };
var service;
var blueIcon;
var greenIcon;

var markers = [];
var showing = [];
var current;
var currentRestaurantId;
var newRestaurantId;
const mode = "add";

function visualizeArea(area) {
    console.log(area.name);
    var circle = new google.maps.Circle({      fillColor: "#FF0000",});
    circle.setCenter({lat: area.center[0], lng: area.center[1]});
    circle.setRadius(area.radius);
    circle.setVisible(true);
    circle.setMap(map)
}

function searchRestaurant(input) {
  console.log('searching ', input);
  service.findPlaceFromQuery(request, function(results, status) {
    if (status === google.maps.places.PlacesServiceStatus.OK) {
      for (var i = 0; i < results.length; i++) {
        createMarker(results[i]);
      }
      map.setCenter(results[0].geometry.location);
    }
  });
}

function makeProgress(i){
  bar.style.width = i+'%';
  bar.innerText = i+'%';
  bar.setAttribute('aria-valuenow', i);
}

function srcToFile(src, fileName, mimeType){
  return (fetch(src)
  .then(function(res){return res.arrayBuffer();})
  .then(function(buf){return new File([buf], fileName, {type:mimeType});})
);
}

function readURL(input) {
  if (input.files && input.files[0]) {
    var reader = new FileReader();
    var filesize = ((input.files[0].size/1024)/1024).toFixed(4);
    console.log(`Initial File : ${filesize} MB`);
    reader.onload = function(e) {
      var quality = 30;
      var output_format = "image/png";
      console.log("Quality >>" + quality);

      console.log("process start...");
      var time_start = new Date().getTime();

      var img = new Image();
      img.src = e.target.result;
      img.onload = function() {
        preview.src = jic.compress(img,quality,output_format).src;
        //15/7 fixing bug of same file name will caused replacing old image in firebase
        var dateTime = new Date();
        imageFileName = dateTime + ".jpg";
        srcToFile(
          preview.src,
          imageFileName,
          'jpg'
        )
        .then(function(file){
          miniFile = file;
          filesize = ((file.size/1024)/1024).toFixed(4);
          console.log(`Finished compressing : ${filesize} MB`)
        })

        preview.onload = function(){
          var image_width = preview.style.width,
          image_height = preview.style.height;

          if(image_width > image_height){
            preview.style.width="320px";
          }else{
            preview.style.height="300px";
          }
          preview.style.display = "block";
          document.getElementById('uploadLabel').style.display = "none";
          document.getElementById('sendBtn').style.display = "block";
          //Ricardo add re-upload button
          document.getElementById('reUploadBtn').style.display = "block";
          document.getElementById('tags').style.display = "block";
        }
        var duration = new Date().getTime() - time_start;

        console.log('Processed in: ' + duration + 'ms');
      }
    }

    reader.readAsDataURL(input.files[0]);
  } else {
    console.log("You must load an image first!");
  }
}

//Ricardo: re-upload
function reUpload() {
  document.getElementById('uploadLabel').style.display = "block";
  document.getElementById('sendBtn').style.display = "none";
  document.getElementById('reUploadBtn').style.display = "none";
  preview.style.display = "none";
  console.log(preview);
}

//Ricardo: email validation
function ValidateEmail(mail) {
  var emailFormat = /^(?:[\w\!\#\$\%\&\'\*\+\-\/\=\?\^\`\{\|\}\~]+\.)*[\w\!\#\$\%\&\'\*\+\-\/\=\?\^\`\{\|\}\~]+@(?:(?:(?:[a-zA-Z0-9](?:[a-zA-Z0-9\-](?!\.)){0,61}[a-zA-Z0-9]?\.)+[a-zA-Z0-9](?:[a-zA-Z0-9\-](?!$)){0,61}[a-zA-Z0-9]?)|(?:\[(?:(?:[01]?\d{1,2}|2[0-4]\d|25[0-5])\.){3}(?:[01]?\d{1,2}|2[0-4]\d|25[0-5])\]))$/;
  return emailFormat.test(mail.value);
}

//create the map
function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: 22.3, lng: 114.2},
    zoom: 12,
    styles: [{
      featureType: 'poi',
      stylers: [{ visibility: 'off' }]  // Turn off points of interest.
    }, {
      featureType: 'transit.station',
      stylers: [{ visibility: 'off' }]  // Turn off bus stations, train stations, etc.
    }],
    disableDoubleClickZoom: true,
    streetViewControl: false
  });
  console.log('initializing map');
  db.collection('restaurants').get().then((snapshot) => {
    snapshot.docs.forEach(doc => {
    var restaurantData = doc.data();
    addRestMarker(restaurantData, doc.id);
    });
  }).then(() => {
    newRestaurantId = (markers.length + 1);
    console.log(newRestaurantId);
  }); 
  service = new google.maps.places.PlacesService(map);
}
  
//helper function
function addToList(tagName, id) {
  console.log('add id' + id);            
  db.collection('tagLists').doc(tagName).update({
    docID: firebase.firestore.FieldValue.arrayUnion(id)
  });
}

function upload() {
  uploadTags();
  if (emailInput.value.length == 0) {
    helloMessageOutput.innerText = "Looks like you haven't provided an email";
    return;
  }
  //Ricardo: check for invalid email
  if (!ValidateEmail(emailInput)) {
  helloMessageOutput.innerText = "You have entered an invalid email address!";
  return;
  }
  if (helloMessageInput.value.length == 0) {
    helloMessage = 'No Hello... :(';
  }
  else {
    helloMessage = helloMessageInput.value;
  }

  //var file = document.getElementById('preview').files[0];

  var metadata = {
    contentType: 'image/jpeg'
  };

  var uploadTask = storageRef.child('images/' + miniFile.name).put(miniFile, metadata);

  // Listen for state changes, errors, and completion of the upload.
  uploadTask.on(firebase.storage.TaskEvent.STATE_CHANGED, // or 'state_changed'
    function(snapshot) {
      // Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
      var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
      helloMessageOutput.innerText = `Uploading Receipt ...`;
      console.log('Upload is ' + progress + '% done');
      makeProgress(Math.round(progress));
      switch (snapshot.state) {
        case firebase.storage.TaskState.PAUSED: // or 'paused'
        console.log('Upload is paused');
        break;
        case firebase.storage.TaskState.RUNNING: // or 'running'
        console.log('Upload is running');
        break;
      }
    }, function(error) {
      // A full list of error codes is available at
      // https://firebase.google.com/docs/storage/web/handle-errors
      switch (error.code) {
        case 'storage/unauthorized':
        // User doesn't have permission to access the object
        break;

        case 'storage/canceled':
        // User canceled the upload
        break;

        case 'storage/unknown':
        // Unknown error occurred, inspect error.serverResponse
        break;
      }
    }, function() {
      // Upload completed successfully, now we can get the download URL
      uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL) {
        db.collection("receipts").add({
          email: emailInput.value,
          helloMessage: helloMessage,
          fileURL: imgURL = downloadURL,
          //15/7 add 
          dish: dishInput.value,          
          location: [current.position.lat(), current.position.lng()],
          restaurant: restaurantInput.value,
          //17/7 add            
          imageName: imageFileName,
          tags: tagList,
          //31/7 add
          approved: false,
          category: category,

        })
        .then(function(docRef) {
          console.log("Document written with ID: ", docRef.id);
          helloMessageOutput.innerText = `File received with ID: ${docRef.id}`; 
          console.log("refresh the map");
          console.log(newRestaurantId);
          newMarker();
          newRestaurantId = docRef.id; 
          var dishes = {
            dish: dishInput.value,
            fileURL: imgURL,
            category: category,
            tags: tagList
          };
          console.log(currentRestaurantId);
          if(currentRestaurantId){
            console.log(currentRestaurantId);
            db.collection("restaurants").doc(currentRestaurantId.toString()).get().then((doc) => {
            console.log(doc.exists);
              if(doc.exists){                
                console.log('exist');
                var couponRemains = doc.data().coupon;
                var getCoupon = false;
                if(couponRemains > 0){
                  console.log('get coupon');
                  couponRemains -= 1;
                  getCoupon = true;
                }              
                console.log(currentLocation);
                console.log(doc.data().location);
                if(isAccurate(currentLocation, doc.data().location)){
                  console.log('accurate');
                  addToRestaurant(dishes, couponRemains, getCoupon);
                }else{
                  addNewRestaurant(dishes);
                }              
              }else{
                addNewRestaurant(dishes);
              }
            })
          }else{
            addNewRestaurant(dishes);
          }      
        })
        .catch(function(error) {
          console.error("Error adding document: ", error);
          helloMessageOutput.innerText = `Error adding document: ${error}`;
        });              
        
      });
    }
  );
    document.getElementById("addBtn").style.display = "block";
}

function isAccurate(pos1, pos2) {
    var latDiff = Math.abs(pos1[0] - pos2[0]);
    var lngDiff = Math.abs(pos1[1] - pos2[1]);
    return (latDiff < 0.0001 && lngDiff < 0.0001);
}

function addToRestaurant(dish, couponRemains, getCoupon) {
  db.collection('restaurants').doc(currentRestaurantId.toString()).update({
      dishes: firebase.firestore.FieldValue.arrayUnion(dish),
      coupon:  couponRemains
  });
  if(getCoupon)alert('You get a coupon');
}

function addNewRestaurant(dishes) {
  console.log('not exist');
  var initArray = [];
  db.collection("restaurants").doc(newRestaurantId.toString()).set({
    name: restaurantInput.value,
    location: currentLocation,
    dishes: initArray,
    id: newRestaurantId,
    coupon: 0
  }).then(
    db.collection('restaurants').doc(newRestaurantId.toString()).update({
        dishes: firebase.firestore.FieldValue.arrayUnion(dishes),
    })
  );
}

</script>
<!-- make map -->

</body>
</html>
