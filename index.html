<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Hello, Vegan!</title>
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/sidebar.css">
  <link href="css/selectbox.css" rel="stylesheet">
  <link href="css/autocomplete.css" rel="stylesheet">
  <link rel="stylesheet" href="css/leaflet.css" />
  <link rel="stylesheet" href="css/slideshow.css" />
  <link rel="stylesheet" href="css/leaflet-search.src.css" />
  <link rel="stylesheet" href="css/tagsinput.css" />
  <!-- Make sure you put this AFTER Leaflet's CSS -->
  <script src="js/leaflet.js" ></script>
  <style>
  #mapid { height: 480px; }
  </style>
</head>
<body>

  <div class="container">
    <div class="jumbotron">
      <p class="text-center">
        <a href="main.html">
          <img src="images/i128x128.png" class="img-responsive" style="margin:0 auto;" alt="Responsive image">
        </a>
      </p>
      <h1 class="text-center">Hello!</h1>
      <p class="text-center">
        A simple hello could lead to wonderful things <small>v1.0.0</small>
      </p>
    </div>

    <!-- Message input field -->
    <div class="row justify-content-center">
      <div class="col-sm-6 form-group">
        <input type="text"
        class="form-control input-lg"
        id="emailInput"
        placeholder="Enter your email here...">
      </div>
    </div>

<div id="mapid"></div>

    <!-- Ricardo: input location-->
    <div id="mapSection" style="display: none;">
      <div id="sidebar-wrapper">
        <div id="toggle-btn" onclick="toggleSidebar()">
          <div></div>
          <div></div>
          <div></div>
        </div>
        <div id="sidebar">
          <h3 id="restaurantName">Restaurant</h3>
          <h4 id="restName"></h4>
          <hr>
          <h3 id="restaurantLocation">location</h3>
          <h4 id="restLocation"></h4>
          <h3>Dishes</h3>
          <div id="restaurantDish">
            <div id="slideContainer"></div>
            <div class="dotSection">
              <span class="dot"></span>
            </div>
          </div>
        </div>
      </div>
      <div id="map" style="width: 100%; height: 70vh;"></div>
    </div>
    <div class="row justify-content-center">
      <div class="col-sm-6">
        <p id="instruction" style="display: none;">Please drag the red pin to the place you want to choose</p>
        <input type="url" id="locationInput" class="form-control input-lg" style="display: none;" >
        <p><label id="locationLabel" for="locationInput" class="btn btn-primary my-2 btn-default btn-block btn-lg" style="display: none;" onclick="getCurrentLocation()">Set Location</label></p>
        <input type="text" id="address" class="form-control input-lg" style="display: none;">

        <p><label id="addressConfirm" for="address" class="btn btn-primary my-2 btn-default btn-block btn-lg" style="cursor: pointer;display: none;">Confirm Address</label></p>
      </div>
    </div>
    <!-- Ricardo: input restaurant -->
  <div id="after-location-loaded">
    <div class="row justify-content-center">
      <div class="col-sm-6 form-group">
        <div class="autocomplete">
          <input type="text"
          class="form-control input-lg"
          id="restaurantInput"
          placeholder="What is the name of the restaurant?"
          >
        </div>
      </div>
    </div>

    <!-- Ricardo: input dish -->
    <div class="row justify-content-center">
      <div class="col-sm-6 form-group">
        <input type="text"
        class="form-control input-lg"
        id="dishInput"
        data-toggle="popover" title="Popover title" data-placement="top" data-content="MEAT FREE, DAIRY FREE & EGG FREE ; 無肉，無蛋奶"
        placeholder="What is the name of the dish?">
      </div>
    </div>

    <div class="row justify-content-center">
      <div class="col-sm-6 form-group">
        <input type="text"
        class="form-control input-lg"
        id="helloMessageInput"
        placeholder="How do you like the Vegan Dish?">
      </div>
    </div>

    <div class="row justify-content-center">
      <img id="preview" src="" />
    </div>
    <div class="row justify-content-center" >
      <input type="file" id="customFile" accept="image/*" style="display: none;" onChange="readURL(this)">
      <p><label id="uploadLabel" for="customFile" class="btn btn-primary my-2 btn-default btn-block btn-lg" style="cursor: pointer;">Upload Image</label></p>
    </div>
  </div>

    <!-- Ricardo Re-upload button -->
    <div class="row justify-content-center">
      <div class="col-xs-12">
        <button id="reUploadBtn" class="btn btn-success my-2 btn-default btn-block btn-lg" style="display: none;" onClick="reUpload()">
          Re-Upload Photo
        </button>

      </div>
    </div>

    <div class="row justify-content-center">
      <div class="col-xs-12" id="tags" style="display: none;">
        <div id="selectbox-container">
          <form>
            <label for="name">Cuisine:</label>
            <select name="" id="indexCuisines">
              <option value="">Please Select</option>
            </select>

            <span id="indexCategoryBlock">
              <label for="name">Category:</label>
              <select name="" id="indexCategories">
                <option value="">Please Select</option>
              </select>
            </span>

            <span id="indexIngredientBlock">
              <label for="name">Ingredient:</label>
              <!--
              <input type="text" id="name" placeholder="Enter an ingredient">

              <button id="btnAdd">Add</button>


              <label for="indexList">Ingredient List:</label>
            --><input id="indexIngredients" type="text" data-role="tagsinput" value="">
            <!-- <select id="indexIngredients" name="indexIngredients" multiple data-role="tagsinput">
  <option value="Amsterdam">Amsterdam</option>
  <option value="Washington">Washington</option>
  <option value="Sydney">Sydney</option>
  <option value="Beijing">Beijing</option>
  <option value="Cairo">Cairo</option>
</select> -->
              <!-- <select id="indexList" name="indexList" multiple>

              </select> -->
              <!--
              <button id="btnRemove">Remove Selected Ingredient</button>
            -->
            </span>
          </form>
        </div>

        <script>
          // const btnAdd = document.querySelector('#btnAdd');
          // const btnRemove = document.querySelector('#btnRemove');
          // const sb = document.querySelector('#indexList');
          // const name = document.querySelector('#name');
          // //Regex for Valid Characters i.e. Alphabets and Numbers.
          // const regex = /^[A-Za-z\s]+$/
          //
          // if (btnAdd) {
          //   btnAdd.onclick = (e) => {
          //     e.preventDefault();
          //
          //     // validate the option
          //     if (name.value == '') {
          //       alert('Please enter the name.');
          //       return;
          //     }
          //
          //     //Validate TextBox value against the Regex.
          //     var isValid = regex.test(name.value);
          //     if (!isValid) {
          //       alert("Only Alphabets and Numbers allowed.");
          //     }
          //
          //     // create a new option
          //     const option = new Option(name.value, name.value);
          //     // add it to the list
          //     sb.add(option, undefined);
          //
          //     // reset the value of the input
          //     name.value = '';
          //     name.focus();
          //   };
          // };
          //
          // // remove selected option
          // if (btnRemove) {
          //   btnRemove.onclick = (e) => {
          //     e.preventDefault();
          //
          //     // save the selected option
          //     let selected = [];
          //
          //     for (let i = 0; i < sb.options.length; i++) {
          //       selected[i] = sb.options[i].selected;
          //     }
          //
          //     // remove all selected option
          //     let index = sb.options.length;
          //     while (index--) {
          //       if (selected[index]) {
          //         sb.remove(index);
          //       }
          //     }
          //   }
          // };
        </script>
      </div>
    </div>

    <!-- Ricardo tags-->
    <div class="row justify-content-center" >
      <div class="col-xs-12 btn-group-toggle" id="tags" style="display: none;">
        <input type="checkbox" id="gluten-free" name="">
        <label for="gluten-free">Gluten-free</label>
        <input type="checkbox" id="egg-free" name="">
        <label for="egg-free">Egg-free</label>
        <br>
        <input type="checkbox" id="dairy-free" name="">
        <label for="dairy-free">Dairy-free</label>
        <input type="checkbox" id="treenut-free" name="">
        <label for="treenut-free">Treenut-free</label>
        <br>
        <input type="checkbox" id="peanut-free" name="">
        <label for="peanut-free">Peanut-free</label>
        <input type="checkbox" id="soy-free" name="">
        <label for="soy-free">Soy-free</label>
        <br>
        <input type="checkbox" id="raw" name="">
        <label for="raw">Raw</label>
        <input type="checkbox" id="vegan" name="">
        <label for="vegan">Vegan</label>
        <br>
        <input type="checkbox" id="buddhist-friendly" name="">
        <label for="buddhist-friendly">Buddhist-friendly</label>
        <input type="checkbox" id="all-natural" name="">
        <label for="all-natural">All natural</label>
      </div>
    </div>

    <!-- Send button -->
    <div class="row justify-content-center">
      <div class="col-xs-12">
        <button id="sendBtn" class="btn btn-success my-2 btn-default btn-block btn-lg" style="display: none;" onClick="upload()">
          Send
        </button>
      </div>
    </div>

    <!-- Add another dish button -->
    <div class="row justify-content-center">
      <div class="col-xs-12">
        <button id="addBtn" class="btn btn-success my-2 btn-default btn-block btn-lg" style="display: none;" onClick="refreshMap()">
          Add another dish
        </button>
      </div>
    </div>
  </div>

  <div class="row justify-content-center">
    <a href="main.html">
      <label id="back" class="btn btn-primary my-2 btn-default btn-block btn-lg" style="cursor: pointer;">Back to Main</label>
    </a>
  </div>

  <hr>

  <!-- Place to show the latest message -->
  <h2 class="text-center"></h2>
  <h3 id="helloMessageOutput" class="text-center text-warning">
    <span class="text-info"></span>
  </h3>

  <div class="progress md-progress" style="height: 20px">
    <div id="progressBar" class="progress-bar progress-bar-striped bg-success" role="progressbar" style="width: 0%; height: 15px" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
  </div>
  <hr>
</div>

<script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-storage.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-analytics.js"></script>
<script defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAEJpg61U3rDVLKE9A0MZ-1i7F1FezKpTQ
        &libraries=visualization,places,geometry&callback=initMap">
        /*Maybe need to change to yours maps to makes it work, change the src above to
          https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap
          and replace the "YOUR_API_KEY" by an enabled google maps API key.
          The guide lines can be found in the link below.
          https://developers.google.com/maps/documentation/javascript/get-api-key
        */
</script>
<script src="js/JIC.min.js" type="text/javascript"></script>
<script src="js/jquery-3.5.1.min.js"></script>
<script src="js/bootstrap.bundle.min.js" type="text/javascript"></script>
<script src="js/autocomplete.js"></script>
<script src="js/autocomplete2.js"></script>
<script src="js/tagsinput.js"></script>
<script src="js/leaflet-search.src.js"></script>
<script defer src="js/mapHelper.js" type="text/javascript"></script>
<script>
//Ricardo: testing
$(document).ready(function(){
  $('[data-toggle="popover"]').popover({
    trigger: 'focus'
  });
});

window.addEventListener('load', initializeRestaurantsOnLoad);



var mymap = L.map('mapid');
L.tileLayer('https://b.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxNativeZoom: 18,
    maxZoom: 20,
    attribution: '&copy; <a target="_blank" rel="noopener" href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(mymap);

var browserGeolocationSuccess = function(position) {
  currentLocation = [position.coords.latitude, position.coords.longitude];
  onLocationFound("You are here.");
};

var browserGeolocationFail = function(error) {
  onLocationFound("Refresh to find your location");
}

if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(
    browserGeolocationSuccess, browserGeolocationFail,
    {maximumAge: 70000, timeout: 40000, enableHighAccuracy: true}
  );
} else {
  onLocationFound("Cannot find your location");
}

function onMapClick(e) {
  var popup = L.popup();
    popup
        .setLatLng(e.latlng)
        .setContent("You clicked the map at " + e.latlng.toString())
        .openOn(mymap);
}

	function onLocationFound(message) {
    mymap.setView(currentLocation, 13);
    var radius = 1;
    circle = L.circle(currentLocation, {
        color: 'red',
        fillColor: '#f03',
        fillOpacity: 0.5,
        radius: 5
    }).addTo(mymap);
    let p = circle.bindPopup(message).openPopup();
    mymap.on('click', onMapClick);
	}

//Ricardo: current
const firebaseConfig = {
    apiKey: "AIzaSyBg34hCq_jGHdj-HNWi2ZjfqhM2YgWq4ek",
    authDomain: "pay-a-vegan.firebaseapp.com",
    databaseURL: "https://pay-a-vegan.firebaseio.com",
    projectId: "pay-a-vegan",
    storageBucket: "pay-a-vegan.appspot.com",
    messagingSenderId: "587888386485",
    appId: "1:587888386485:web:3a81137924d19cbe2439fc",
    measurementId: "G-MGJK6GF9YW"
  };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
var storageRef = firebase.storage().ref();
var storage = firebase.storage();

// DOM element shortcuts.
var emailInput = document.getElementById('emailInput');
var helloMessageInput = document.getElementById('helloMessageInput');
var helloMessageOutput= document.getElementById('helloMessageOutput');
var preview= document.getElementById('preview');
var bar= document.getElementById('progressBar');
var miniFile = '';
// added in 15/7
var dishInput = document.getElementById('dishInput');
var searchInput = document.getElementById('searchInput');
var restaurantInput = document.getElementById('restaurantInput');
var locationInput = document.getElementById('locationInput');
var map;
// added in 16/7
var defaultLocation = [22.3, 114.16];
var currentLocation = [22.276, 114.173];
var contentString = '<div>' +
                restaurantInput.value +
                '</div>' +
                '<div>' +
                dishInput.value +
                '</div>' +
                '<div>' +
                preview.value +
                '</div>' ;
// added in 17/7
var imageFileName;
// added in 20/7
var isGlutenFree;
var isEggFree;
var isDairyFree;
var isTreenutFree;
var isPeanutFree;
var isSoyFree;
var isRaw;
var isVegan;
var isBuddhistFriendly;
var isAllNatural;
var referenceID;
// added in 23/7
var imgURL;

var request = {
    query: restaurantInput.value,
    fields: ['name', 'formatted_address', 'geometry'],
  };
var service;
var blueIcon;
var greenIcon;

var markers = [];
var showing = [];
var circle;
var current;
var currentLeaflet;
var currentRestaurantId;
var newRestaurantId;
var dishArray = [];
var restaurantHash = {};
const mode = "add";

if (typeof(Storage) !== "undefined") {
  emailInput.innerHTML = localStorage.getItem("email");
  emailInput.addEventListener("input", function(e) {
    var val = this.value;
    if (ValidateEmail(emailInput)) {
      localStorage.setItem("email", emailInput.value.trim());
    }
  });
}

function visualizeArea(area) {
    console.log(area.name);
    var circle = new google.maps.Circle({      fillColor: "#FF0000",});
    circle.setCenter({lat: area.center[0], lng: area.center[1]});
    circle.setRadius(area.radius);
    circle.setVisible(true);
    circle.setMap(map)
}

function searchRestaurant(input) {
  console.log('searching ', input);
  service.findPlaceFromQuery(request, function(results, status) {
    if (status === google.maps.places.PlacesServiceStatus.OK) {
      for (var i = 0; i < results.length; i++) {
        createMarker(results[i]);
      }
      map.setCenter(results[0].geometry.location);
    }
  });
}

function makeProgress(i){
  bar.style.width = i+'%';
  bar.innerText = i+'%';
  bar.setAttribute('aria-valuenow', i);
}

function srcToFile(src, fileName, mimeType){
  return (fetch(src)
  .then(function(res){return res.arrayBuffer();})
  .then(function(buf){return new File([buf], fileName, {type:mimeType});})
);
}

function readURL(input) {
  if (input.files && input.files[0]) {
    var reader = new FileReader();
    var filesize = ((input.files[0].size/1024)/1024).toFixed(4);
    console.log(`Initial File : ${filesize} MB`);
    reader.onload = function(e) {
      var quality = 30;
      var output_format = "image/png";
      console.log("Quality >>" + quality);

      console.log("process start...");
      var time_start = new Date().getTime();

      var img = new Image();
      img.src = e.target.result;
      img.onload = function() {
        preview.src = jic.compress(img,quality,output_format).src;
        //15/7 fixing bug of same file name will caused replacing old image in firebase
        var dateTime = new Date();
        imageFileName = dateTime + ".jpg";
        srcToFile(
          preview.src,
          imageFileName,
          'jpg'
        )
        .then(function(file){
          miniFile = file;
          filesize = ((file.size/1024)/1024).toFixed(4);
          console.log(`Finished compressing : ${filesize} MB`)
        })

        preview.onload = function(){
          var image_width = preview.style.width,
          image_height = preview.style.height;

          if(image_width > image_height){
            preview.style.width="320px";
          }else{
            preview.style.height="300px";
          }
          preview.style.display = "block";
          document.getElementById('uploadLabel').style.display = "none";
          document.getElementById('sendBtn').style.display = "block";
          //Ricardo add re-upload button
          document.getElementById('reUploadBtn').style.display = "block";
          document.getElementById('tags').style.display = "block";
        }
        var duration = new Date().getTime() - time_start;

        console.log('Processed in: ' + duration + 'ms');
      }
    }

    reader.readAsDataURL(input.files[0]);
  } else {
    console.log("You must load an image first!");
  }
}

//Ricardo: re-upload
function reUpload() {
  document.getElementById('uploadLabel').style.display = "block";
  document.getElementById('sendBtn').style.display = "none";
  document.getElementById('reUploadBtn').style.display = "none";
  document.getElementById('tags').style.display = "none";
  preview.style.display = "none";
  console.log(preview);
}

//Ricardo: email validation
function ValidateEmail(mail) {
  var emailFormat = /^(?:[\w\!\#\$\%\&\'\*\+\-\/\=\?\^\`\{\|\}\~]+\.)*[\w\!\#\$\%\&\'\*\+\-\/\=\?\^\`\{\|\}\~]+@(?:(?:(?:[a-zA-Z0-9](?:[a-zA-Z0-9\-](?!\.)){0,61}[a-zA-Z0-9]?\.)+[a-zA-Z0-9](?:[a-zA-Z0-9\-](?!$)){0,61}[a-zA-Z0-9]?)|(?:\[(?:(?:[01]?\d{1,2}|2[0-4]\d|25[0-5])\.){3}(?:[01]?\d{1,2}|2[0-4]\d|25[0-5])\]))$/;
  return emailFormat.test(mail.value);
}

//create the map
function initMap() {
  // map = new google.maps.Map(document.getElementById('map'), {
  //   center: {lat: 22.3, lng: 114.2},
  //   zoom: 12,
  //   styles: [{
  //     featureType: 'poi',
  //     stylers: [{ visibility: 'off' }]  // Turn off points of interest.
  //   }, {
  //     featureType: 'transit.station',
  //     stylers: [{ visibility: 'off' }]  // Turn off bus stations, train stations, etc.
  //   }],
  //   disableDoubleClickZoom: true,
  //   streetViewControl: false
  // });
  console.log('initializing markers');
  db.collection('restaurants').get().then((snapshot) => {
    // console.log('snapshot:' + snapshot);
    snapshot.docs.forEach(doc => {
      var restaurantData = doc.data();
      let marker = addRestMarker(restaurantData, doc.id);
      marker.addTo(mymap);
      let restaurantDishes = restaurantHash[restaurantData.name];
      restaurantDishes = restaurantDishes || [];
      restaurantData.dishes.forEach(data => {
        dishArray.push(data.dish);
        restaurantDishes.push(data.dish);
      });
      restaurantHash[restaurantData.name] = [...(new Set(restaurantDishes))].sort();
    });
  }).then(() => {
    dishArray = [...(new Set(dishArray))].sort();
    console.log("dishArray:", dishArray);
    autocomplete2(document.getElementById("dishInput"), dishArray);
  });
}

function initializeRestaurantsOnLoad() {
  console.log("window load");
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
    .then(function(registration) {
      console.log('serviceWorker Registered');
    })
    .catch(function(error) {
      console.log('serviceWorker Registration failed: ', error);
    });
    navigator.serviceWorker.ready.then( () => {
      console.log("serviceWorker ready");
    })
  }
}

function upload() {
  uploadTags();
  if (emailInput.value.length == 0) {
    helloMessageOutput.innerText = "Looks like you haven't provided an email";
    return;
  }
  //Ricardo: check for invalid email
  if (!ValidateEmail(emailInput)) {
    helloMessageOutput.innerText = "You have entered an invalid email address!";
    return;
  }
  if (helloMessageInput.value.length == 0) {
    helloMessageOutput.innerText = "Looks like you haven't provided a review";
    return;
  }
  else {
    helloMessage = helloMessageInput.value;
  }

  var metadata = {
    contentType: 'image/jpeg'
  };

  var uploadTask = storageRef.child('images/' + miniFile.name).put(miniFile, metadata);

  // Listen for state changes, errors, and completion of the upload.
  uploadTask.on(firebase.storage.TaskEvent.STATE_CHANGED, // or 'state_changed'
    function(snapshot) {
      // Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
      var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
      helloMessageOutput.innerText = `Uploading Receipt ...`;
      console.log('Upload is ' + progress + '% done');
      makeProgress(Math.round(progress));
      switch (snapshot.state) {
        case firebase.storage.TaskState.PAUSED: // or 'paused'
        console.log('Upload is paused');
        break;
        case firebase.storage.TaskState.RUNNING: // or 'running'
        console.log('Upload is running');
        break;
      }
    }, function(error) {
      // A full list of error codes is available at
      // https://firebase.google.com/docs/storage/web/handle-errors
      switch (error.code) {
        case 'storage/unauthorized':
        // User doesn't have permission to access the object
        break;

        case 'storage/canceled':
        // User canceled the upload
        break;

        case 'storage/unknown':
        // Unknown error occurred, inspect error.serverResponse
        break;
      }
    }, function() {
      // Upload completed successfully, now we can get the download URL
      console.log("currentLeaflet getLatLng");
      console.log(currentLeaflet.getLatLng());
      let currentLat = currentLeaflet.getLatLng().lat;
      let currentLng = currentLeaflet.getLatLng().lng;
      let uploadCuisine = document.getElementById('indexCuisines').value;
      uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL) {
        db.collection("receipts").add({
          email: emailInput.value,
          helloMessage: helloMessage,
          fileURL: imgURL = downloadURL,
          dish: dishInput.value,
          location: [currentLat, currentLng],
          restaurant: restaurantInput.value,
          imageName: imageFileName,
          tags: ($('#indexIngredients').val().split(",")),
          approved: false,
          category: category,
          cuisine: uploadCuisine
        })
        .then(function(docRef) {
          console.log("Document written with ID: ", docRef.id);
          helloMessageOutput.innerText = `File received with ID: ${docRef.id}`;
          //newMarker();
          newRestaurantId = docRef.id;
          var dishes = {
            dish: dishInput.value,
            fileURL: imgURL,
            category: category,
            tags: ($('#indexIngredients').val().split(","))
          };
          if(currentRestaurantId){
            db.collection("restaurants").doc(currentRestaurantId.toString()).get().then((doc) => {
              if(doc.exists){
                var couponRemains = doc.data().coupon;
                var getCoupon = false;
                if(couponRemains > 0){
                  couponRemains -= 1;
                  getCoupon = true;
                }
                if(isAccurate(currentLocation, doc.data().location)){
                  console.log('accurate');
                  db.collection('restaurants').doc(currentRestaurantId.toString()).update({
                    dishes: firebase.firestore.FieldValue.arrayUnion(dishes),
                    coupon:  couponRemains,
                    cuisines: firebase.firestore.FieldValue.arrayUnion(uploadCuisine)
                  });
                }else{
                  //addNewRestaurant(dishes);
                }
              }else{
                //addNewRestaurant(dishes);
              }
            })
          }else{
            //addNewRestaurant(dishes);
          }
        })
        .catch(function(error) {
          console.error("Error adding document: ", error);
          helloMessageOutput.innerText = `Error adding document: ${error}`;
        });

      });
    }
  );
    document.getElementById("addBtn").style.display = "block";
}

function isAccurate(pos1, pos2) {
    var latDiff = Math.abs(pos1[0] - pos2[0]);
    var lngDiff = Math.abs(pos1[1] - pos2[1]);
    return (latDiff < 0.0001 && lngDiff < 0.0001);
}

function addNewRestaurant(dishes) {
  console.log('not exist');
  var initArray = [];
  db.collection("restaurants").doc(newRestaurantId.toString()).set({
    name: restaurantInput.value,
    location: currentLocation,
    dishes: initArray,
    id: newRestaurantId,
    coupon: 0
  }).then(
    db.collection('restaurants').doc(newRestaurantId.toString()).update({
        dishes: firebase.firestore.FieldValue.arrayUnion(dishes),
    })
  );
}

</script>
<!-- make map -->

</body>
</html>
